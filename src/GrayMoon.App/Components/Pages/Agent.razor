@page "/agent"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using GrayMoon.App.Services
@using System.Text.Json
@inject IAgentBridge AgentBridge
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject ILogger<Agent> Logger

<PageTitle>Agent - GrayMoon</PageTitle>

<div class="container-fluid page-container">
    <div class="row mb-4">
        <div class="col-12">
            <h2>Agent</h2>
            <p class="text-muted">Install the agent and view diagnostic information</p>
        </div>
    </div>

    @* Install Agent and Diagnostics in two columns *@
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0 bg-blue">Install GrayMoon Agent</h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">Run this PowerShell command as Administrator to install the GrayMoon Agent as a Windows service:</p>
                    <div class="input-group">
                        <input type="text" class="form-control font-monospace bg-dark" id="installCommand" readonly 
                               value="@installCommand" />
                        <button class="btn btn-primary" type="button" @onclick="CopyInstallCommand">Copy</button>
                    </div>
                    <small class="text-muted mt-2 d-block">
                        The script will download, install, and start the agent service automatically.
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Agent Diagnostics</h5>
                </div>
                <div class="card-body">
                    @if (isLoading)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2 mb-0">Loading diagnostics...</p>
                        </div>
                    }
                    else if (errorMessage != null)
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                        @if (!isAgentConnected)
                        {
                            <div class="alert alert-warning">
                                The agent is not connected. Please ensure the GrayMoon Agent service is running.
                            </div>
                        }
                    }
                    else if (diagnostics != null)
                    {
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <th scope="row" style="width: 30%;">Agent Version</th>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(diagnostics.AgentVersion))
                                            {
                                                <code>@diagnostics.AgentVersion</code>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not available</span>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Agent Platform</th>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(diagnostics.AgentPlatform))
                                            {
                                                <span class="badge bg-info">@diagnostics.AgentPlatform</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">Not available</span>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row">Git.exe Version</th>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(diagnostics.GitVersion))
                                            {
                                                <code>@diagnostics.GitVersion</code>
                                            }
                                            else
                                            {
                                                <span class="text-danger">Not installed</span>
                                                <div class="mt-2">
                                                    <small class="text-muted">Install Git using:</small>
                                                    <div class="input-group input-group-sm mt-1" style="max-width: 500px;">
                                                        <input type="text" class="form-control font-monospace bg-dark" 
                                                               value="winget install Git.Git" readonly />
                                                        <button class="btn btn-primary btn-sm" type="button" 
                                                                @onclick='() => CopyToClipboard("winget install Git.Git")'>Copy</button>
                                                    </div>
                                                </div>
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row">GitVersion Tool Version</th>
                                        <td>
                                            @if (!string.IsNullOrWhiteSpace(diagnostics.GitVersionToolVersion))
                                            {
                                                <code>@diagnostics.GitVersionToolVersion</code>
                                            }
                                            else
                                            {
                                                <span class="text-warning">Not installed</span>
                                                <div class="mt-2">
                                                    <small class="text-muted">Install GitVersion Tool using:</small>
                                                    <div class="input-group input-group-sm mt-1" style="max-width: 500px;">
                                                        <input type="text" class="form-control font-monospace bg-light" 
                                                               value="dotnet tool install GitVersion.Tool --global --version 5.*" readonly />
                                                        <button class="btn btn-primary btn-sm" type="button" 
                                                                @onclick='() => CopyToClipboard("dotnet tool install GitVersion.Tool --global --version 5.*")'>Copy</button>
                                                    </div>
                                                </div>
                                            }
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" @onclick="RefreshDiagnostics">Refresh</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>


@code {
    private DiagnosticsInfo? diagnostics;
    private bool isLoading = true;
    private string? errorMessage;
    private bool isAgentConnected;
    private string installCommand = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var baseUrl = NavigationManager.BaseUri.TrimEnd('/');
        var installUrl = $"{baseUrl}/api/agent/install";
        installCommand = $"Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('{installUrl}'))";
        
        await LoadDiagnosticsAsync();
    }

    private async Task LoadDiagnosticsAsync()
    {
        isLoading = true;
        errorMessage = null;
        isAgentConnected = AgentBridge.IsAgentConnected;
        
        try
        {
            if (!isAgentConnected)
            {
                errorMessage = "Agent is not connected. Please ensure the GrayMoon Agent service is running.";
                isLoading = false;
                return;
            }

            var response = await AgentBridge.SendCommandAsync("GetDiagnostics", new { });
            
            if (response.Success && response.Data != null)
            {
                var json = response.Data is JsonElement je ? je.GetRawText() : JsonSerializer.Serialize(response.Data);
                using var doc = JsonDocument.Parse(json);
                var root = doc.RootElement;
                
                diagnostics = new DiagnosticsInfo
                {
                    AgentVersion = root.TryGetProperty("agentVersion", out var av) ? av.GetString() : null,
                    AgentPlatform = root.TryGetProperty("agentPlatform", out var ap) ? ap.GetString() : null,
                    GitVersion = root.TryGetProperty("gitVersion", out var gv) ? gv.GetString() : null,
                    GitVersionToolVersion = root.TryGetProperty("gitVersionToolVersion", out var gvtv) ? gvtv.GetString() : null
                };
            }
            else
            {
                errorMessage = response.Error ?? "Failed to retrieve diagnostics from agent.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading agent diagnostics");
            errorMessage = $"Error loading diagnostics: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshDiagnostics()
    {
        await LoadDiagnosticsAsync();
    }

    private async Task CopyInstallCommand()
    {
        await CopyToClipboard(installCommand);
    }

    private async Task CopyToClipboard(string text)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", text);
    }

    private sealed class DiagnosticsInfo
    {
        public string? AgentVersion { get; set; }
        public string? AgentPlatform { get; set; }
        public string? GitVersion { get; set; }
        public string? GitVersionToolVersion { get; set; }
    }
}