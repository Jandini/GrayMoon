@inject IJSRuntime JS
@implements IAsyncDisposable

<div class="loading-overlay @(IsVisible ? "show" : "")" aria-hidden="@(!IsVisible)">
    <canvas id="@_canvasId" class="matrix-canvas"></canvas>
    <div class="loading-overlay__veil"></div>
    <div class="loading-overlay-content">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        @if (!string.IsNullOrEmpty(Message))
        {
            <p class="loading-overlay-message">@Message</p>
        }
        @if (OnAbort.HasDelegate)
        {
            <button type="button" class="btn btn-outline-light btn-sm" @onclick="AbortClicked">Abort</button>
        }
    </div>
</div>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string? Message { get; set; }
    [Parameter] public EventCallback OnAbort { get; set; }

    /// <summary>Dim strength 0..100 (45 = default).</summary>
    [Parameter] public int DimOpacityPercent { get; set; } = 45;

    /// <summary>Matrix rain: character size in px.</summary>
    [Parameter] public int FontSize { get; set; } = 16;
    /// <summary>Matrix rain: frame interval in ms (~30 FPS = 33).</summary>
    [Parameter] public int FrameIntervalMs { get; set; } = 33;
    /// <summary>Matrix rain: trail length (e.g. 0.08).</summary>
    [Parameter] public double FadeAlpha { get; set; } = 0.08;
    /// <summary>Matrix rain: character opacity (e.g. 0.65).</summary>
    [Parameter] public double CharacterOpacity { get; set; } = 0.65;

    private readonly string _canvasId = "matrixOverlay_" + Guid.NewGuid().ToString("N");
    private bool _wasVisible;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync("matrixOverlay.setDim", _canvasId, DimOpacityPercent / 100.0);

        if (IsVisible && !_wasVisible)
        {
            await JS.InvokeVoidAsync("matrixOverlay.start", _canvasId, new
            {
                fontSize = FontSize,
                frameIntervalMs = FrameIntervalMs,
                fadeAlpha = FadeAlpha,
                characterOpacity = CharacterOpacity
            });
        }
        else if (!IsVisible && _wasVisible)
        {
            await JS.InvokeVoidAsync("matrixOverlay.stop", _canvasId);
        }

        _wasVisible = IsVisible;
    }

    private async Task AbortClicked() => await OnAbort.InvokeAsync();

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("matrixOverlay.stop", _canvasId);
        }
        catch (Exception)
        {
            // JS interop may be unavailable (e.g. circuit disconnected); ignore
        }
    }
}
