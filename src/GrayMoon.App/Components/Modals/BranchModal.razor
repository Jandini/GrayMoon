@using System.Text.Json
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager NavigationManager
@inject ILogger<BranchModal> Logger

@if (IsVisible)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);"
         @onkeydown="HandleKeyDown"
         @ref="modalElement">
        <div class="modal-dialog branch-modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(string.IsNullOrEmpty(WorkspaceName) ? "Branch" : $"{WorkspaceName} Branch")</h5>
                    <button type="button" class="btn-close" @onclick="OnCancel"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs branch-modal-tabs mb-3" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link @(activeTab == "newbranch" ? "active" : "")"
                                    type="button"
                                    role="tab"
                                    @onclick='() => SetActiveTab("newbranch")'>
                                New Branch
                            </button>
                        </li>
                    </ul>

                    @if (activeTab == "newbranch")
                    {
                        @if (errorMessage != null)
                        {
                            <div class="alert alert-danger alert-dismissible d-flex align-items-start" role="alert">
                                <div class="flex-grow-1" style="white-space: pre-wrap; word-wrap: break-word;">@errorMessage</div>
                                <button type="button" class="btn-close ms-2" aria-label="Close" @onclick='() => { errorMessage = null; StateHasChanged(); }'></button>
                            </div>
                        }
                        <div class="mb-3">
                            <label class="form-label" for="new-branch-name">Branch name</label>
                            <input id="new-branch-name"
                                   type="text"
                                   class="form-control"
                                   placeholder="e.g. feature/my-feature"
                                   @bind="newBranchName"
                                   @bind:event="oninput"
                                   @ref="newBranchNameInput" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="based-on">Based on</label>
                            <div class="position-relative">
                                <button type="button"
                                        id="based-on"
                                        class="new-branch-based-on-trigger border rounded w-100 d-flex align-items-center gap-2 text-start"
                                        style="cursor: pointer; padding: 0.375rem 0.75rem;"
                                        @onclick="ToggleBasedOnDropdown">
                                    <span class="d-flex align-items-center gap-2 flex-grow-1 min-w-0">
                                        <span class="text-truncate">@GetSelectedBaseDisplayText()</span>
                                        @if (selectedBaseBranch == "__default__")
                                        {
                                            <span class="badge bg-success flex-shrink-0">Default</span>
                                        }
                                    </span>
                                    <i class="bi bi-chevron-down flex-shrink-0 text-secondary"></i>
                                </button>
                                @if (showBasedOnDropdown)
                                {
                                    <ul class="list-unstyled border rounded mt-1 mb-0 py-1 new-branch-based-on-list position-absolute start-0 end-0 shadow"
                                        style="z-index: 1050; max-height: 280px; overflow-y: auto; font-size: 1rem;">
                                        <li class="new-branch-based-on-item px-3 py-2 @(selectedBaseBranch == "__default__" ? "selected" : "")"
                                            style="cursor: pointer;"
                                            @onclick='() => SelectBaseBranch("__default__")'>
                                            <span>@DefaultDisplayText</span>
                                            <span class="badge bg-success ms-2">Default</span>
                                        </li>
                                        @foreach (var branch in CommonBranchNames)
                                        {
                                            <li class="new-branch-based-on-item px-3 py-2 @(selectedBaseBranch == branch ? "selected" : "")"
                                                style="cursor: pointer;"
                                                @onclick='() => SelectBaseBranch(branch)'>
                                                @branch
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    @if (activeTab == "newbranch")
                    {
                        <button type="button" class="btn btn-primary" @onclick="CreateAsync" disabled="@(string.IsNullOrWhiteSpace(newBranchName) || isCreating)">
                            @if (isCreating)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Create
                        </button>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="OnCancel" disabled="@isCreating">Cancel</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public string? WorkspaceName { get; set; }
    [Parameter] public int WorkspaceId { get; set; }
    [Parameter] public IReadOnlyList<string> CommonBranchNames { get; set; } = Array.Empty<string>();
    /// <summary>Display text for the default option: e.g. "main" when all repos same default, or "multiple" when different.</summary>
    [Parameter] public string DefaultDisplayText { get; set; } = "multiple";
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public EventCallback<(string NewBranchName, string BaseBranch)> OnCreateBranch { get; set; }

    private string activeTab = "newbranch";
    private string newBranchName = "";
    private string selectedBaseBranch = "__default__";
    private bool isCreating = false;
    private string? errorMessage;
    private bool showBasedOnDropdown = false;
    private ElementReference modalElement;
    private ElementReference newBranchNameInput;
    private bool _wasVisible;

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private string GetSelectedBaseDisplayText()
    {
        if (selectedBaseBranch == "__default__")
            return DefaultDisplayText;
        return selectedBaseBranch;
    }

    private void ToggleBasedOnDropdown()
    {
        showBasedOnDropdown = !showBasedOnDropdown;
    }

    private void SelectBaseBranch(string value)
    {
        selectedBaseBranch = value;
        showBasedOnDropdown = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsVisible && !_wasVisible)
        {
            _wasVisible = true;
            activeTab = "newbranch";
            newBranchName = "";
            selectedBaseBranch = "__default__";
            errorMessage = null;
            try
            {
                await newBranchNameInput.FocusAsync();
            }
            catch { }
        }
        else if (!IsVisible)
        {
            _wasVisible = false;
            showBasedOnDropdown = false;
        }
    }

    private async Task CreateAsync()
    {
        var name = newBranchName?.Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            errorMessage = "Enter a branch name.";
            return;
        }
        var baseBranch = selectedBaseBranch ?? "__default__";

        isCreating = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            await OnCreateBranch.InvokeAsync((name, baseBranch));
        }
        finally
        {
            isCreating = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Escape" || e.Code == "Escape")
        {
            await OnCancel.InvokeAsync();
        }
    }
}
